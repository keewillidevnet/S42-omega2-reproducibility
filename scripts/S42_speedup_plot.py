#!/usr/bin/env python3
"""Generate speedup-vs-precision plot for S_{4,2}(x) at x in {1/2,1/4,-1/2}.
Requires: mpmath, matplotlib
Run: python3 S42_speedup_plot.py
"""

import time
import mpmath as mp
import matplotlib.pyplot as plt

BASIS_STR = [
  "1.0173430619844491397145179297909205279018174900328535618424086640043321829019578978827739779385351705302791911622545588673981814483331018538",
  "1.4449407984336342339136850788069878271837354057638886741314341618985838561313541019661930985185174806599319223819314744048249236406120965543",
  "0.71874354992198019283046391226527800210320216721762327656429451194077374473374896093919107419364331725726759745570288393714949361601143578562",
  "0.40031458184561419203091613857990902568117780469906264447519044158847304709471103532385936477386623308429828589071287581120849197235564399262",
  "46.800491370318922582539672240948015673741666156954551293626080005374201988815160419839940150636564227485482919020098520562258275139790984817",
  "2.2782511049014964064870271398211043414188524251684197685813128855853320374668636326428397339782653855275657087594247647912486975999481814737",
  "0.11090541883234759167194710079574490532302299046528211727061634035990444477939668626009639566696904838903166763924557349947022144918058082246",
  "0.5040953978039885506900465097888790952065222893266744492313452610836359208556675584443398687621171250763298271376476163093611930829582538256",
  "0.25099901796289268872877534871006111284433375076597299307274191193713102922471208637240745754518228434649161678011750584487290114594240220163",
  "0.35239642809682161102923845366367559633465251065012321168987434453488086625495695570980197877660469071585378645840596739098624320057956392679",
  "0.17468805328621835002101791644134328415359997934824771332381298892252349047839316361806998589403487814641499138667956412142690874014727992994",
  "0.24862437482078779528583360298408913469744097049105625723196850923071486073268397937352656267847437991161054116731111721799788763244198398113",
  "0.12209088972949331804630816587568605512530189582666978994190661948732021422322111928229096616677392486339665011343789265584883206510085776464",
  "5.1073136245683090243881980317684776637612392063973555231317889858697482316259847167042183236337503843572587225051190996170601720212107085941",
  "2.5080262745781750902418243968214416669241837540260108540050821844992469857048041351434626249095309107918105458722330135202818771373716699302",
  "0.87929973257869859251359495616251356095212847934677238157757918413839615440215502575172034795669665045373650213584690693246451866709896715716",
  "9.0390464452472998756892179742768874340217708050133556224702477857434783361375867030653923963481444201350464784768987213446710730772570740652",
  "98.86453933295462150876637119447155208995285841003525505762441965350780114633883082796291404692198120315881076342478747481905355267713586595",
  "10.166743294844129696759617219514611535397606145854736962551853563857831060696206821515701816285811706822423100655111465647660460762013397572",
  "1.0454979097728327997128153317610389312321138001745519669145086083872830500726437510624745010943454815899376555828062860456080345824417917574",
  "1.0"
]
C12 = [
  "15683/14280",
  "-5743/14280",
  "-1593/4760",
  "-34213/14280",
  "-653/357",
  "107/7140",
  "933/595",
  "-4129/14280",
  "-5221/4760",
  "457/595",
  "457/595",
  "-1868/1785",
  "291/476",
  "-911/408",
  "167/7140",
  "-619/408",
  "-3869/3570",
  "15359/14280",
  "1007/2856",
  "-7613/7140",
  "-141/2380"
]
C14 = [
  "6037/23939",
  "540/23939",
  "-9470/23939",
  "16159/23939",
  "-24385/23939",
  "18371/23939",
  "20947/23939",
  "1027/23939",
  "-8180/23939",
  "-39717/23939",
  "565/23939",
  "13069/23939",
  "-6410/23939",
  "22392/23939",
  "-55113/23939",
  "9961/23939",
  "3040/23939",
  "391/647",
  "-29476/23939",
  "-31660/23939",
  "-6389/23939"
]
CM12 = [
  "2879/58060",
  "139667/116120",
  "-44803/116120",
  "-20309/29030",
  "5495/23224",
  "-31603/58060",
  "-112611/116120",
  "5441/29030",
  "9087/116120",
  "-8581/116120",
  "46081/116120",
  "-26413/58060",
  "-61269/116120",
  "57493/58060",
  "-14287/11612",
  "-47941/116120",
  "-9771/29030",
  "4109/58060",
  "-83559/58060",
  "-6695/23224",
  "-181073/116120"
]

def parse_frac(s: str):
    if "/" in s:
        a,b = s.split("/")
        return mp.mpf(int(a)) / mp.mpf(int(b))
    return mp.mpf(int(s))

def parse_coeffs(lst):
    return [parse_frac(s) for s in lst]

def basis_values(dps):
    mp.mp.dps = dps
    return [mp.mpf(s) for s in BASIS_STR]

def eval_closed(coeffs, basis, dps):
    mp.mp.dps = dps
    total = mp.mpf('0')
    for c, bv in zip(coeffs, basis):
        if c:
            total += c*bv
    return total

def S42_series(x, dps, tol_digits, max_n=900000):
    mp.mp.dps = dps
    x = mp.mpf(x)
    H = mp.mpf('0')
    s = mp.mpf('0')
    xn = x
    n = 1
    tol = mp.power(10, -tol_digits)
    small = 0
    while True:
        term = H*xn/(n**5)
        s += term
        H += mp.mpf(1)/n
        n += 1
        xn *= x
        if abs(term) < tol:
            small += 1
        else:
            small = 0
        if small >= 35:
            break
        if n > max_n:
            break
    return s

def time_mean(fn, nrep):
    t0 = time.perf_counter()
    out = None
    for _ in range(nrep):
        out = fn()
    t1 = time.perf_counter()
    return (t1 - t0)/nrep, out

def main():
    dps_list = [50, 80, 120, 160]
    targets = [
        ("S42(1/2)", "0.5", parse_coeffs(C12)),
        ("S42(1/4)", "0.25", parse_coeffs(C14)),
        ("S42(-1/2)", "-0.5", parse_coeffs(CM12)),
    ]
    results = {name: [] for name,_,_ in targets}
    avg = []

    for dps in dps_list:
        tol = max(20, dps - 25)
        n_series = 3
        n_closed = 2000
        basis = basis_values(dps)
        sps = []
        for name, x, coeffs in targets:
            ts, _ = time_mean(lambda: S42_series(x, dps=dps, tol_digits=tol), n_series)
            tc, _ = time_mean(lambda: eval_closed(coeffs, basis, dps), n_closed)
            sp = ts/tc
            results[name].append(sp)
            sps.append(sp)
        avg.append(sum(sps)/len(sps))

    plt.figure()
    for name, vals in results.items():
        plt.plot(dps_list, vals, marker='o', label=name)
    plt.plot(dps_list, avg, marker='o', linewidth=2, label="Average")
    plt.xlabel("mpmath precision (decimal digits)")
    plt.ylabel("Speedup (series / closed-form)")
    plt.title("Speedup vs Precision for S_{4,2}(x): Series vs Î©2 Fully-Folded Closed Form")
    plt.legend()
    plt.savefig("S42_speedup_vs_precision.png", bbox_inches="tight", dpi=200)
    print("Wrote S42_speedup_vs_precision.png")

if __name__ == "__main__":
    main()
